#!/usr/bin/env bash

read -r -d '' HELP_TEXT << EOF
Usage: $(basename "$0") [OPTIONS] <command> <working_dir>

Optional Parameters:
  <command>         Command used to open files in \`$EDITOR\`
	<working_dir>     Optionally specify a working directory to open yazi into:

Options:
  -h, --help        Show this help message and exit.

Environment Variables:
  ZIDE_FILE_PICKER  File picker to use. Currently supporting "yazi" and "nnn", defaults
                    to "yazi".
  ZIDE_YAZI_CONFIG  Custom yazi config file location to customize yazi on
                    launch. Only used when using yazi as your picker.

Description:
  Wrapper around Yazi that handles sending picked files to \`$EDITOR\` pane and
  then re-opening Yazi. If a directory was the picked path, Yazi will re-open in
  that directory as its new working dir.
EOF

# Function to display the help text
show_help() {
  echo "$HELP_TEXT"
}

# Program to use as a picker
picker=""

# Parse command-line options
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      show_help
      exit 0
      ;;
    -p|--picker)
      # picker="$1"
      # shift 2
      if [[ -n "$2" && "$2" != -* ]]; then
        picker="$2"
        shift 2
      else
        echo "Error: --picker requires a non-empty value."
        exit 1
      fi
      ;;
    -*)
      echo "Unknown option: $1"
      echo "Use --help or -h for usage information."
      exit 1
      ;;
    *)
      # Stop processing options when a positional parameter is encountered
      break
      ;;
  esac
done

# Optional params
#
# Command to perform on the paths, available commands will be based on your editor
command=${1}
# Optionally specify a working directory to open yazi into
working_dir=${2} 

# Get paths to edit based on picker
paths=""
case "${picker:-${ZIDE_FILE_PICKER:-"yazi"}}" in
  yazi)
    if ! command -v yazi &> /dev/null; then
      echo "Error: 'yazi' is not installed or not in your PATH." >&2
      exit 1
    fi
    
    # Yazi picker config location
    yaziConfig=${ZIDE_YAZI_CONFIG:-"${ZIDE_DIR}/yazi"}

    # Point yazi to the config directory for opening as a single layout pane
    export YAZI_CONFIG_HOME="${yaziConfig}"

    # Use yazi to pick our files
    paths=$(yazi ${working_dir} --chooser-file=/dev/stdout | while read -r; do printf "%q " "$REPLY"; done)
    ;;
  nnn)
    if ! command -v nnn &> /dev/null; then
      echo "Error: 'nnn' is not installed or not in your PATH." >&2
      exit 1
    fi

    # Use nnn to pick our files
    paths=$(nnn -p - ${working_dir} | while read -r; do printf "%q " "$REPLY"; done)
    ;;
  *)
    echo "Error: Invalid argument '$arg'"
    show_help
    exit 1
    ;;
esac

# Open the paths in the $EDITOR
printf "%s" "${paths}" | zide-edit ${command}

# Grab the directory of the first provided path so we can reopen yazi in it
path=${paths[0]}
dir=${path}
if [[ -f "${path}" ]]; then
	dir=$(dirname "${path}")
fi

# Yazi exits once we pick paths, so re-open it manually by re-running this very script, and set
# the working dir to be the dir of the first path
"$0" --picker ${picker} ${command} ${dir}
