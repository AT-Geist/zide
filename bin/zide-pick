#!/usr/bin/env bash

read -r -d '' HELP_TEXT << EOF
Usage: $(basename "$0") [OPTIONS] <command> <working_dir>

Optional Parameters:
  <command>         Command used to open files in \`$EDITOR\`
	<working_dir>     Optionally specify a working directory to open the file
	                  picker into.

Options:
  -h, --help        Show this help message and exit.
  -p, --picker      File picker to use. Available file pickers are listed in
                    bin/lib. Setting this will override the ZIDE_FILE_PICKER
                    env var.
  -N, --no-reopen   If set, will not try to re-open the picker after picking files

Environment Variables:
  ZIDE_FILE_PICKER  File picker to use. Available file pickers are listed in
                    bin/lib.

Description:
  Wrapper around Yazi that handles sending picked files to \`$EDITOR\` pane and
  then re-opening Yazi. If a directory was the picked path, Yazi will re-open in
  that directory as its new working dir.
EOF

# Function to display the help text
show_help() {
  echo "$HELP_TEXT"
}

# Program to use as a picker
picker=""
# Whether to re-open the picker after picking
no_reopen=false

# Parse command-line options
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      show_help
      exit 0
      ;;
    -p|--picker)
      if [[ -n "$2" && "$2" != -* ]]; then
        picker="$2"
        shift 2
      else
        echo "Error: --picker requires a non-empty value."
        exit 1
      fi
      ;;
    -N|--no-reopen)
      no_reopen=true
      shift
      ;;
    -*)
      echo "Unknown option: $1"
      echo "Use --help or -h for usage information."
      exit 1
      ;;
    *)
      # Stop processing options when a positional parameter is encountered
      break
      ;;
  esac
done

# Optional params
#
# Command to perform on the paths, available commands will be based on your editor
command=${1}
# Optionally specify a working directory to open yazi into
working_dir=${2} 

# Read picker defaults from env var or hard-coded default if a flag not passed
picker=${picker:-${ZIDE_FILE_PICKER:-"yazi"}}

# Get paths to edit based on picker from picker command
paths=$("${ZIDE_DIR}/bin/pickers/zide-pick-${picker}" "${working_dir}")

# Open the paths in the $EDITOR
zide-edit --command "${command}" "${paths}" 

# Grab the directory of the first provided path so we can reopen yazi in it
path=${paths[0]}
dir=${path}
if [[ -f "${path}" ]]; then
	dir=$(dirname "${path}")
fi

if ! ${no_reopen}; then
  # Pickers exit once we pick paths, so re-open it manually by re-running this very script, and set
  # the working dir to be the dir of the first path
  "$0" --picker ${picker} ${command} ${dir}
fi
